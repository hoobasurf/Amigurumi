<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestion Amigurumi</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="owner-body">

  <h1>Ajouter une crÃ©ation Amigurumi ğŸ§¸ğŸ’–</h1>

  <div class="form-container">
    <label>Nom de la peluche :</label>
    <input id="name" type="text" placeholder="ex : Princesse Lapinou" />

    <label>Photos :</label>
    <input id="photo" type="file" accept="image/*" multiple />

    <label>Rendre publique :</label>
    <select id="public">
      <option value="true">Oui (visible dans l'album)</option>
      <option value="false">Non (privÃ©)</option>
    </select>

    <button id="save">Enregistrer la crÃ©ation</button>
    <p id="status">ğŸ“¤ PrÃªt Ã  uploader des imagesâ€¦</p>
  </div>

  <h3>Mes projets existants :</h3>
  <div id="projects-container" style="display:flex;gap:10px;flex-wrap:wrap;"></div>

  <script type="module">
    import { db } from "./firebase.js";

    const saveBtn = document.getElementById("save");
    const nameInput = document.getElementById("name");
    const photosInput = document.getElementById("photo");
    const status = document.getElementById("status");
    const projectsContainer = document.getElementById("projects-container");

    saveBtn.onclick = async function saveCreation() {
      const name = nameInput.value.trim();
      const files = Array.from(photosInput.files);
      const isPublic = document.getElementById("public").value === "true";

      if (!name || files.length === 0) {
        status.innerHTML = "âš ï¸ Remplis le nom et choisis au moins une image.";
        return;
      }

      status.innerHTML = "ğŸ“¤ DÃ©but upload via Netlify Functionâ€¦";
      const uploadedUrls = [];

      for (let file of files) {
        const reader = new FileReader();
        reader.readAsDataURL(file);

        await new Promise((resolve, reject) => {
          reader.onload = async () => {
            try {
              const base64Data = reader.result.split(",")[1]; // enlÃ¨ve data:image/â€¦
              const res = await fetch("/.netlify/functions/upload", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: file.name, fileBase64: base64Data })
              });
              const data = await res.json();
              if (data.url) {
                uploadedUrls.push(data.url);
                status.innerHTML += `<br>âœ… ${file.name} uploadÃ©`;
              } else {
                status.innerHTML += `<br>âŒ ${file.name} : Erreur function`;
              }
              resolve();
            } catch (err) {
              status.innerHTML += `<br>âŒ ${file.name} : ${err.message}`;
              reject(err);
            }
          };
          reader.onerror = err => reject(err);
        });
      }

      if (uploadedUrls.length > 0) {
        status.innerHTML += "<br>ğŸ“ Enregistrement dans Firestoreâ€¦";
        const { collection, addDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js");

        try {
          await addDoc(collection(db, "creations"), {
            name,
            imageUrls: uploadedUrls,
            mainImage: uploadedUrls[0],
            public: isPublic,
            createdAt: serverTimestamp()
          });
          status.innerHTML += "<br>ğŸ‰ CrÃ©ation ajoutÃ©e !";
          nameInput.value = "";
          photosInput.value = "";
          displayMiniatures(uploadedUrls);
        } catch (err) {
          status.innerHTML += `<br>âŒ Erreur Firestore : ${err.message}`;
          console.error(err);
        }
      }
    };

    function displayMiniatures(urls) {
      projectsContainer.innerHTML = "";
      urls.forEach(url => {
        const img = document.createElement("img");
        img.src = url;
        img.style.width = "80px";
        img.style.height = "80px";
        img.style.objectFit = "cover";
        img.style.border = "2px solid #f7c6da";
        img.style.borderRadius = "8px";
        img.style.margin = "3px";
        projectsContainer.appendChild(img);
      });
    }
  </script>
</body>
</html>
