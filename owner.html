<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestion Amigurumi</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    #projects-container img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border: 2px solid #f7c6da;
      border-radius: 8px;
      margin: 3px;
    }
  </style>
</head>
<body class="owner-body">

  <h1>Ajouter une crÃ©ation Amigurumi ğŸ§¸ğŸ’–</h1>

  <div class="form-container">
    <label>Nom de la peluche :</label>
    <input id="name" type="text" placeholder="ex : Princesse Lapinou" />

    <label>Photos :</label>
    <input id="photo" type="file" accept="image/*" multiple />

    <label>Rendre publique :</label>
    <select id="public">
      <option value="true">Oui (visible dans l'album)</option>
      <option value="false">Non (privÃ©)</option>
    </select>

    <button id="save">Enregistrer</button>
    <p id="status">ğŸ“¤ PrÃªt Ã  uploader des imagesâ€¦</p>
  </div>

  <h3>Mes projets existants :</h3>
  <div id="projects-container"></div>

  <script type="module">
    import { db, storage } from "./firebase.js";
    import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

    const saveBtn = document.getElementById("save");
    const nameInput = document.getElementById("name");
    const photoInput = document.getElementById("photo");
    const publicSelect = document.getElementById("public");
    const status = document.getElementById("status");
    const projectsContainer = document.getElementById("projects-container");

    // Fonction pour afficher les miniatures
    function displayMiniatures(urls) {
      projectsContainer.innerHTML = "";
      urls.forEach(url => {
        const img = document.createElement("img");
        img.src = url;
        projectsContainer.appendChild(img);
      });
    }

    // Upload direct vers Firebase Storage + Firestore
    saveBtn.onclick = async function() {
      const name = nameInput.value.trim();
      const files = Array.from(photoInput.files);
      const isPublic = publicSelect.value === "true";

      if (!name || files.length === 0) {
        status.innerHTML = "âš ï¸ Remplis le nom et choisis au moins une image.";
        return;
      }

      status.innerHTML = "ğŸ“¤ DÃ©but de l'uploadâ€¦";
      const uploadedUrls = [];

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        status.innerHTML += `<br>â³ Upload de l'image ${i+1} / ${files.length} : ${file.name}â€¦`;

        try {
          const imageRef = ref(storage, "images/" + Date.now() + "_" + file.name);
          await uploadBytes(imageRef, file);
          const url = await getDownloadURL(imageRef);
          uploadedUrls.push(url);
          status.innerHTML += `<br>âœ… Upload rÃ©ussi : ${file.name}`;
        } catch (err) {
          status.innerHTML += `<br>âŒ Erreur upload ${file.name} : ${err.message}`;
          console.error(err);
        }
      }

      if (uploadedUrls.length > 0) {
        status.innerHTML += "<br>ğŸ“ Enregistrement dans Firestoreâ€¦";

        try {
          await addDoc(collection(db, "creations"), {
            name,
            imageUrls: uploadedUrls,
            mainImage: uploadedUrls[0],
            public: isPublic,
            createdAt: serverTimestamp()
          });
          status.innerHTML += "<br>ğŸ‰ CrÃ©ation ajoutÃ©e !";
          displayMiniatures(uploadedUrls);

          // Reset form
          nameInput.value = "";
          photoInput.value = "";
        } catch (err) {
          status.innerHTML += `<br>âŒ Erreur Firestore : ${err.message}`;
          console.error(err);
        }
      }
    }
  </script>

</body>
</html>
